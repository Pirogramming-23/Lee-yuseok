{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pirostagram</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            background: #fafafa;
        }
        .insta-feed {
            max-width: 500px;
            margin: 40px auto;
        }
        .insta-card {
            background: #fff;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .insta-card-header {
            display: flex;
            align-items: center;
            padding: 16px;
        }
        .insta-profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            border: 1px solid #dbdbdb;
        }
        .insta-card-img {
            width: 100%;
            height: 350px;
            object-fit: cover;
            background: #eee;
        }
        .insta-card-body {
            padding: 16px;
        }
        .insta-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .insta-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .insta-content {
            color: #262626;
        }
    </style>
</head>
<body>
<div class="insta-feed">
    {% csrf_token %}
    {% for post in posts %}
    <div class="insta-card">
        <div class="insta-card-header">
            <img src="https://randomuser.me/api/portraits/lego/1.jpg" class="insta-profile-img" alt="profile">
            <span class="fw-bold">익명 사용자</span>
            <button type="button" class="btn btn-link btn-sm text-danger ms-auto" onclick="deletePost({{ post.id }})">게시글 삭제</button>
        </div>
        <img id="post-img-{{ post.id }}" class="insta-card-img" alt="post image">
        <div class="insta-card-body">
            <div class="insta-actions">
                <button class="btn btn-outline-danger btn-sm post__like" onclick="onClickLike({{ post.id }}, 'like')" id="like-btn-{{ post.id }}">
                    ❤️ <span id="like-count-{{ post.id }}">{{ post.like }}</span>
                </button>
                <button class="btn btn-outline-secondary btn-sm post__dislike" onclick="onClickLike({{ post.id }}, 'dislike')" id="dislike-btn-{{ post.id }}">
                    💔 <span id="dislike-count-{{ post.id }}">{{ post.dislike }}</span>
                </button>
            </div>
            <div class="insta-title">{{ post.title }}</div>
            <div class="insta-content">{{ post.content }}</div>
            <!-- 댓글 목록 -->
            <div class="mt-3" id="comment-list-{{ post.id }}">
                {% for comment in post.comments.all %}
                    <div class="border-bottom py-1 small" id="comment-{{ comment.id }}">
                        {{ comment.content }} <span class="text-muted" style="font-size:0.8em">({{ comment.created_at|date:'Y-m-d H:i' }})</span>
                        <button type="button" class="btn btn-link btn-sm text-danger p-0 ms-2" onclick="deleteComment({{ comment.id }})">삭제</button>
                    </div>
                {% empty %}
                    <div class="text-muted small">아직 댓글이 없습니다.</div>
                {% endfor %}
            </div>
            <!-- 댓글 작성 폼 -->
            <form class="d-flex mt-2" onsubmit="return submitComment(event, {{ post.id }})">
                <input type="text" class="form-control form-control-sm me-2" name="content" placeholder="댓글을 입력하세요..." required>
                <button type="submit" class="btn btn-primary btn-sm">등록</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
<!-- Bootstrap JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function onClickLike(postId, type) {
    fetch('/like_ajax/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({id: postId, type: type})
    })
    .then(response => response.json())
    .then(data => {
        if (data.type === 'like') {
            // 좋아요 카운트 증가
            const likeCount = document.getElementById(`like-count-${data.id}`);
            likeCount.textContent = parseInt(likeCount.textContent) + 1;
        } else {
            // 안좋아요 카운트 증가
            const dislikeCount = document.getElementById(`dislike-count-${data.id}`);
            dislikeCount.textContent = parseInt(dislikeCount.textContent) + 1;
        }
    });
}

function submitComment(event, postId) {
    event.preventDefault();
    const form = event.target;
    const content = form.content.value;
    fetch(`/comment_create/${postId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `content=${encodeURIComponent(content)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.content) {
            const commentList = document.getElementById(`comment-list-${postId}`);
            const newComment = document.createElement('div');
            newComment.className = 'border-bottom py-1 small';
            newComment.innerHTML = `${data.content} <span class='text-muted' style='font-size:0.8em'>(${data.created_at})</span>`;
            commentList.appendChild(newComment);
            form.reset();
        }
    });
    return false;
}

function deleteComment(commentId) {
    if (!confirm('정말 삭제하시겠습니까?')) return;
    fetch(`/comment_delete/${commentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const commentDiv = document.getElementById(`comment-${commentId}`);
            if (commentDiv) commentDiv.remove();
        } else {
            alert('댓글 삭제에 실패했습니다.');
        }
    });
}

function deletePost(postId) {
    if (!confirm('정말 이 게시글을 삭제하시겠습니까?')) return;
    fetch(`/post_delete/${postId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('게시글 삭제에 실패했습니다.');
        }
    });
}

// 게시글 id 리스트를 JS 배열로 전달
const postIds = [{% for post in posts %}'{{ post.id }}'{% if not forloop.last %}, {% endif %}{% endfor %}];

document.addEventListener('DOMContentLoaded', function() {
    {% for post in posts %}
    axios.get('{% static "img/example.jpg" %}', { responseType: 'blob' })
        .then(function(response) {
            const url = URL.createObjectURL(response.data);
            document.getElementById('post-img-{{ post.id }}').src = url;
        });
    {% endfor %}
});
</script>
</body>
</html>
